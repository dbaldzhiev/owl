# OWL â€” Technical Requirements Document (TRD)

Target Platform: Rhino 8 / Grasshopper (.NET 7)
Language: C# (.NET 7)
API: RhinoCommon, Grasshopper SDK
Domain: Auditoriums, Cinemas, Grandstands, Tribune Renovation, Plan Distribution

---

## 0. Core Design Principle
The project is a **Rhino 8 Grasshopper Plugin** structured into two main projects:
1.  `Owl.Core`: Pure C# logic, primitives, and solvers (Geometry, Analysis). Reference-free from Grasshopper (except where unavoidable for types like Bitmap, though mostly minimized).
2.  `Owl.Grasshopper`: Grasshopper component implementations, UI logic, and data conversion.

Data flows: `Setup Primitives` -> `Solvers (Core)` -> `Grasshopper DataTrees/Geometry`.

---

## 1. Primitives (Owl.Core)

### 1.1 Tribune Setup (`TribuneSetup`)
**Purpose:** Define the base dimensions and stepping logic of the tribune section.

**Properties:**
- `Rows` (int): Number of elevated rows.
- `RowDepth` (double): Depth of a single row module.
- `RowRiseSteps` (List<int>): Steps per row (e.g., [2, 2] means each row rises by 2 steps).
- `StartElevation` (double): Base elevation.

### 1.2 Stair Setup (`StairSetup`)
**Purpose:** Define dimensions of steps (risers/treads).

**Properties:**
- `RiserHeight` (double)
- `TreadDepth` (double)

### 1.3 Railing Setup (`RailingSetup`)
**Purpose:** Define railing dimensions.

**Properties:**
- `Height` (double): Height from nosing.
- `Thickness` (double)

### 1.4 Audience Setup (`AudienceSetup`)
**Purpose:** Define occupant parameters and chair geometry.

**Properties:**
- `EyeHeight` (double)
- `EyeOffset` (double): Horizontal offset from seat back.
- `PlanGeo` (GeometryBase): **[NEW]** 3D geometry (Block/Mesh/Brep) representing the chair in plan.
- `PlanOriginPt` (Point3d): **[NEW]** Insertion point for the `PlanGeo`.
- `ChairWidth` (double): **[NEW]** Width of the chair for distribution.

### 1.5 Plan Setup (`PlanSetup`) **[NEW]**
**Purpose:** Define plan-view boundaries and exclusions.

**Properties:**
- `Origin` (Point3d): Anchor point matching the section origin.
- `TribuneBoundary` (Curve): Closed loop defining the seating area.
- `AisleBoundaries` (List<Curve>): Closed loops defining aisles (voids for chairs, valid for stairs).
- `TunnelBoundary` (Curve): **[NEW]** Closed loop defining a structural tunnel (void for everything).

---

## 2. Solvers & Analysis (Owl.Core)

### 2.1 Tribune Solver (`TribuneSolver`)
**Purpose:** Generate section profile curves.
**Logic:**
- Generates `TribuneProfile` (Section).
- Generates `StairProfile` (Section, typically aligned or offset).
- Generates `RailingProfiles` (Section).

### 2.2 Analysis (`Analysis.Calculate`)
**Purpose:** Core distribution and sightline analysis engine.

**Inputs:**
- Section Setups (Tribune, Railing, Stairs)
- `AudienceSetup` List (Rows)
- `PlanSetup` (Optional)
- Screen & Projector Setups

**Logic (Section):**
- Calculates C-Values (Sightline clearance).
- Checks projector cone intersections.

**Logic (Plan) [NEW]:**
- **Trigger**: Active only if `PlanSetup` is provided.
- **Tribune Lines**: Generated at each row X-coordinate, clipped by `TribuneBoundary` - `TunnelBoundary`.
- **Railing Lines**: Generated at row edges, subtracted by `AisleBoundaries` and `TunnelBoundary`.
- **Stair Lines**: Generated at row edges *inside* `AisleBoundaries`, clipped by `TunnelBoundary`.
- **Chair Distribution**:
    - Along valid `RailingLines`.
    - Spaced by `ChairWidth`.
    - Output as transformed instances of `AudienceSetup.PlanGeo` (Block support).

---

## 3. Grasshopper Components (Owl.Grasshopper)

### 3.1 Setup Components
- **Owl_TribuneSetup**: Inputs for rows, rise, etc.
- **Owl_StairSetup**: Inputs for treads/risers.
- **Owl_RailingSetup**: Inputs for railing dim.
- **Owl_AudienceSetup**: Extended inputs for Plan Geometry.
- **Owl_PlanSetup**: **[NEW]** Inputs for Boundary, Aisles, Tunnel.

### 3.2 Solvers
- **Owl_TribuneSolver**: Visualizes section profiles.
- **Owl_AudienceDistributor**:
    - **Inputs**: Setups, PlanSetup.
    - **Outputs**:
        - `Sightlines` (Lines)
        - `PlanTrib` (List<Curve>)
        - `PlanRail` (List<Curve>)
        - `PlanStair` (List<Curve>)
        - `PlanChairs` (Tree<Geometry>) - Block instances or curves.

---

## 4. Coding Standards

- **C# / .NET 7**: Modern properties, null safety.
- **Separation of Concerns**: Core logic strictly separated from GH UI.
- **Immutability**: Setup objects should be treated as immutable configuration carriers.
